function graph(){var t=flatten(root),e=d3.layout.tree().links(t),r=vis.insert("svg:defs").attr("id","mdefs");r.data(["end"]).enter().append("svg:path").attr("d","M0,-5L10,0L0,5");r.selectAll("pattern").data(t).enter().append("svg:pattern").attr("id",function(t){return hashCode(t.name)}).attr("width",2).attr("height",2).attr("x",0).attr("y",0).append("svg:image").attr("xlink:href",function(t){return t.img}).attr("width",function(t){return t.name===root.name?100:40*Math.sqrt(Math.sqrt(t.size))}).attr("height",function(t){return t.name===root.name?100:40*Math.sqrt(Math.sqrt(t.size))}).attr("x",0).attr("y",0);var n=function(){function r(){n.attr("d",function(t){var e=t.target.x-t.source.x,r=t.target.y-t.source.y,n=Math.sqrt(e*e+r*r);return"M"+t.source.x+","+t.source.y+"A"+n+","+n+" 0 0,1 "+t.target.x+","+t.target.y}),a.attr("transform",nodeTransform)}force.nodes(t).links(e).gravity(.05).charge(-1500).linkDistance(function(t){var e=w>h?1:.15;return Math.sqrt(t.target.size)*((t.target.name.length+10)*e)+35}).friction(.5).linkStrength(function(t,e){return 1}).size([w,h]).on("tick",r).start();var n=vis.selectAll("path.link").data(e,function(t){return t.target.id});n.enter().insert("svg:path").attr("class","link").style("stroke","#ccc").style("fill","transparent"),n.exit().remove();var a=vis.selectAll("g.node").data(t,function(t){return t.id});a.enter().append("svg:g").attr("class","node").attr("transform",function(t){return"translate("+t.x+","+t.y+")"}).on("click",function(t){if(t!=root){var e=t.link;location.href=e}}).call(force.drag).append("svg:circle").attr("r",function(t){return t.name===root.name?50:20*Math.sqrt(Math.sqrt(t.size))}).style("stroke","black").style("stroke-width",1).style("fill",function(t){return"url(#"+hashCode(t.name)+")"}).on("mouseenter",function(){d3.select(this).transition().attr("x",function(t){return-60}).attr("y",function(t){return-60}).attr("height",100).attr("width",100).style("stroke","#3399FF").style("stroke-width",3).style("opacity",.9)}).on("mouseleave",function(){d3.select(this).transition().attr("x",function(t){return-25}).attr("y",function(t){return-25}).attr("height",50).attr("width",50).style("stroke","black").style("stroke-width",1).style("opacity",1)}).on("mouseover",function(t){i.text(t.name),i.style("visibility","visible"),t.name!=root.name&&(1===t.size?s.text("("+t.size+" collaboration)"):s.text("("+t.size+" collaborations)"),s.style("visibility","visible"))}).on("mousemove",function(t){i.style("top",d3.event.pageY-10+"px").style("left",d3.event.pageX+15+"px"),s.style("top",d3.event.pageY+15+"px").style("left",d3.event.pageX+5+"px")}).on("mouseout",function(t){i.style("visibility","hidden"),s.style("visibility","hidden")});var i=d3.select("body").append("div").attr("id","tooltip").style("position","absolute").style("z-index","10").style("visibility","hidden").style("color","white").style("text-shadow","1px 1px 10px black"),s=d3.select("body").append("div").attr("id","tooltipSubtext").style("position","absolute").style("z-index","10").style("visibility","hidden").style("color","white").style("font-size",8).style("text-shadow","1px 1px 10px black");a.exit().remove(),n=vis.selectAll("path.link"),a=vis.selectAll("g.node")};n()}function nodeTransform(t){return t.x=Math.max(maxNodeSize,Math.min(w-40*Math.sqrt(Math.sqrt(t.size)),t.x)),t.y=Math.max(maxNodeSize,Math.min(h-40*Math.sqrt(Math.sqrt(t.size)),t.y)),"translate("+t.x+","+t.y+")"}function flatten(t){function e(t){t.children&&t.children.forEach(e),t.id||(t.id=++n),r.push(t)}var r=[],n=0;return e(t),r}var w=window.innerWidth-15,h=window.innerHeight,maxNodeSize=50,root,vis,force=d3.layout.force();vis=d3.select("#vis").append("svg");var slug=d3.select(".artist_slug").text(),endpoint="/data/artists/"+slug+"/network/";$.getJSON(endpoint,{csrfmiddlewaretoken:"{{csrf_token}}"},function(t){var e,r=flatten(root=t),n=(Math.max.apply(Math,r.map(function(t){return t.size})),r.length),a=n-1;if(e=1==a?" collaborator":" collaborators",a>0){d3.select("#collabs").style("display","inherit"),d3.select("#numCollabs").text(a+e);var i=2.5*Math.sqrt(n)/Math.sqrt(h);i<.175&&(i=.175),h<600&&(i+=.01*n),h*=i,vis.attr("width",w).attr("height",h),root.fixed=!0,root.x=w/2,root.y=h/2,graph()}});var hashCode=function(t){return t.split("").reduce(function(t,e){return(t=(t<<5)-t+e.charCodeAt(0))&t},0)};