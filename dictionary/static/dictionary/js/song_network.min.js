function graph(){var t=flatten(root),e=d3.layout.tree().links(t),n=vis.insert("svg:defs").attr("id","mdefs");n.data(["end"]).enter().append("svg:path").attr("d","M0,-5L10,0L0,5");n.selectAll("pattern").data(t).enter().append("svg:pattern").attr("id",function(t){return hashCode(t.name)}).attr("width",2).attr("height",2).attr("x",0).attr("y",0).append("svg:image").attr("xlink:href",function(t){return t.img}).attr("width",function(t){return t.name===root.name?100:40*Math.sqrt(Math.sqrt(t.size))}).attr("height",function(t){return t.name===root.name?100:40*Math.sqrt(Math.sqrt(t.size))}).attr("x",0).attr("y",0);var r=function(){function n(){r.attr("d",function(t){var e=t.target.x-t.source.x,n=t.target.y-t.source.y,r=Math.sqrt(e*e+n*n);return"M"+t.source.x+","+t.source.y+"A"+r+","+r+" 0 0,1 "+t.target.x+","+t.target.y}),a.attr("transform",nodeTransform)}force.nodes(t).links(e).gravity(.05).charge(-1500).linkDistance(function(t){var e=w>h?1:.15;return Math.sqrt(t.target.size)*(4*t.target.name.length*e)+35}).friction(.5).linkStrength(function(t,e){return 1}).size([w,h]).on("tick",n).start();var r=vis.selectAll("path.link").data(e,function(t){return t.target.id});r.enter().insert("svg:path").attr("class","link").style("stroke","#ccc").style("fill","transparent"),r.exit().remove();var a=vis.selectAll("g.node").data(t,function(t){return t.id});a.enter().append("svg:g").attr("class","node").attr("transform",function(t){return"translate("+t.x+","+t.y+")"}).on("click",function(t){var e=t.link;location.href=e}).call(force.drag).append("svg:circle").attr("r",function(t){return t.name===root.name?50:20*Math.sqrt(Math.sqrt(t.size))}).style("stroke","black").style("stroke-width",1).style("fill",function(t){return"url(#"+hashCode(t.name)+")"}).on("mouseenter",function(){d3.select(this).transition().attr("x",function(t){return-60}).attr("y",function(t){return-60}).attr("height",100).attr("width",100).style("stroke","#3399FF").style("stroke-width",3).style("opacity",.9)}).on("mouseleave",function(){d3.select(this).transition().attr("x",function(t){return-25}).attr("y",function(t){return-25}).attr("height",50).attr("width",50).style("stroke","black").style("stroke-width",1).style("opacity",1)}).on("mouseover",function(t){i.text(t.name),i.style("visibility","visible")}).on("mousemove",function(t){i.style("top",d3.event.pageY-10+"px").style("left",d3.event.pageX+15+"px"),s.style("top",d3.event.pageY+15+"px").style("left",d3.event.pageX+5+"px")}).on("mouseout",function(t){i.style("visibility","hidden"),s.style("visibility","hidden")});var i=d3.select("body").append("div").attr("id","tooltip").style("position","absolute").style("z-index","10").style("visibility","hidden").style("color","white").style("text-shadow","1px 1px 10px black"),s=d3.select("body").append("div").attr("id","tooltipSubtext").style("position","absolute").style("z-index","10").style("visibility","hidden").style("color","white").style("font-size",8).style("text-shadow","1px 1px 10px black");a.exit().remove(),r=vis.selectAll("path.link"),a=vis.selectAll("g.node")};r()}function nodeTransform(t){return t.x=Math.max(maxNodeSize,Math.min(w-40*Math.sqrt(Math.sqrt(t.size)),t.x)),t.y=Math.max(maxNodeSize,Math.min(h-40*Math.sqrt(Math.sqrt(t.size)),t.y)),"translate("+t.x+","+t.y+")"}function flatten(t){function e(t){t.children&&t.children.forEach(e),t.id||(t.id=++r),n.push(t)}var n=[],r=0;return e(t),n}var w=window.innerWidth,h=100,maxNodeSize=50,root,vis,force=d3.layout.force();vis=d3.select("#songVis").append("svg");var slug=d3.select(".song_slug").text(),endpoint="/data/songs/"+slug+"/artist_network/";$.getJSON(endpoint,{csrfmiddlewaretoken:"{{csrf_token}}"},function(t){root=t,console.log(endpoint);var e=flatten(root).length;h+=12*e,d3.select("#numCollabs").text(e),vis.attr("width",w).attr("height",h),root.fixed=!0,root.x=w/2,root.y=h/2,graph()});var hashCode=function(t){return t.split("").reduce(function(t,e){return(t=(t<<5)-t+e.charCodeAt(0))&t},0)};